<script>
	import { onMount } from 'svelte';

	let frame = null;
	let r = 0;
	let a = 0;
	const dr = 0.1;
	const da = 0.15;
	const TAU = Math.PI * 2;
	let rMax = 25;
	let state = null;

	let points = [
		{ x: 0.09887710779360423, y: 0.014943813247359923 },
		{ x: 0.19106729782512122, y: 0.05910404133226791 },
		{ x: 0.2701341307058031, y: 0.13048966023336908 },
		{ x: 0.33013424596387136, y: 0.22585698935801415 },
		{ x: 0.36584443443691045, y: 0.34081938001166706 },
		{ x: 0.37296598096239864, y: 0.46999614577649 },
		{ x: 0.34829973352420884, y: 0.6071962579158119 },
		{ x: 0.2898862035813389, y: 0.7456312687737809 },
		{ x: 0.19710601838373754, y: 0.8781510220439931 },
		{ x: 0.07073720166770311, y: 0.9974949866040543 },
		{ x: -0.08703297768740699, y: 1.0965515312993106 },
		{ x: -0.272642513631704, y: 1.1686171570538342 },
		{ x: -0.48123508075667243, y: 1.2076476295050302 },
		{ x: -0.7067845464398, y: 1.2084931133084236 },
		{ x: -0.9422604340841082, y: 1.1671097953318825 },
		{ x: -1.1798299448659924, y: 1.0807410888818423 },
		{ x: -1.4110910098998775, y: 0.9480623195654099 },
		{ x: -1.62732985563071, y: 0.7692837844208952 },
		{ x: -1.8197957513508716, y: 0.5462082234508362 },
		{ x: -1.979984993200891, y: 0.28224001611973626 },
		{ x: -2.0999257827898186, y: -0.017655219471010238 },
		{ x: -2.1724554937995038, y: -0.3470405271151442 },
		{ x: -2.1914818935669023, y: -0.6981454792293847 },
		{ x: -2.1522201992019547, y: -1.0620490639076434 },
		{ x: -2.0513983933489044, y: -1.4289032968558573 },
		{ x: -1.8874239909203676, y: -1.7881920138783298 },
		{ x: -1.6605064166190535, y: -2.129018186950726 },
		{ x: -1.3727302997539612, y: -2.440412162758047 },
		{ x: -1.0280762886395831, y: -2.7116524749195032 },
		{ x: -0.6323873982923394, y: -2.9325903529952924 },
		{ x: -0.19328039528167423, y: -3.093968760152528 },
		{ x: 0.2799967470062314, y: -3.187726748274691 },
		{ x: 0.7767587617496922, y: -3.2072801290260093 },
		{ x: 1.285124325224139, y: -3.1477699199142894 },
		{ x: 1.7922991703464486, y: -3.0062707269930704 },
		{ x: 2.284894353393491, y: -2.781952155201551 },
		{ x: 2.749271831575725, y: -2.4761874719221635 },
		{ x: 3.1719085823888142, y: -2.0926050618710157 },
		{ x: 3.539769788483819, y: -1.637079669575441 },
		{ x: 3.8406811466014696, y: -1.1176619927956903 },
		{ x: 4.063690152230726, y: -0.5444468262953044 },
		{ x: 4.199406272810345, y: 0.07061838203428848 },
		{ x: 4.2403102543078015, y: 0.7139810552193345 },
		{ x: 4.181023404617524, y: 1.370781999458883 },
		{ x: 4.018528551100836, y: 2.0251983320127973 },
		{ x: 3.75233546057663, y: 2.660822916185736 },
		{ x: 3.3845848135354166, y: 3.2610712411699043 },
		{ x: 2.920086309754805, y: 3.8096057464759467 },
		{ x: 2.3662881141140737, y: 4.290766896605134 },
		{ x: 1.7331765891751074, y: 4.689999883873701 },
		{ x: 1.0331070615923956, y: 4.994265691699622 },
		{ x: 0.2805681869257554, y: 5.192425395947945 },
		{ x: -0.5081157348954594, y: 5.27558701946538 },
		{ x: -1.3151384301732947, y: 5.237404978563457 },
		{ x: -2.121613655987239, y: 5.0743231563163596 },
		{ x: -2.908016463053456, y: 4.785753885294357 },
		{ x: -3.6546534226387424, y: 4.374186594144662 },
		{ x: -4.342150544464927, y: 3.84522153447664 },
		{ x: -4.951946902909763, y: 3.2075258176298975 },
		{ x: -5.466781571308067, y: 2.4727109114505166 },
		{ x: -5.871161354655047, y: 1.6551327280931383 },
		{ x: -6.151797017806138, y: 0.7716174257437639 },
		{ x: -6.297996229750157, y: -0.1588820004050765 },
		{ x: -6.302002277082402, y: -1.1156913998270923 },
		{ x: -6.1592687258569425, y: -2.076874758544797 },
		{ x: -5.8686616073273665, y: -3.0197368989171345 },
		{ x: -5.432582339279867, y: -3.9213580717583523 },
		{ x: -4.857006433784938, y: -4.759147875636101 },
		{ x: -4.151435041615877, y: -5.511405183366912 },
		{ x: -3.32875849597192, y: -6.157870319801695 },
		{ x: -2.405033192582929, y: -6.6802556345228465 },
		{ x: -1.399175326478382, y: -7.062740856478736 },
		{ x: -0.33257714332479194, y: -7.292420204824855 },
		{ x: 0.7713465988061968, y: -7.359689152709506 },
		{ x: 1.887672375538196, y: -7.2585599813344395 },
		{ x: 2.9905305842440058, y: -6.986896795051509 },
		{ x: 4.053704470830106, y: -6.546562461564988 },
		{ x: 5.051251441500269, y: -5.943471954568413 },
		{ x: 5.9581320753975895, y: -5.187548763348469 },
		{ x: 6.7508316698599575, y: -4.292583344003423 },
		{ x: 7.407959029907196, y: -3.275994965077975 },
		{ x: 7.910807466670203, y: -2.1585006891995064 },
		{ x: 8.243863595882658, y: -0.9636975731423283 },
		{ x: 8.395250518208424, y: 0.28243359665762646 },
		{ x: 8.357093299904502, y: 1.5520926443647116 },
		{ x: 8.125796328174763, y: 2.816280176584226 },
		{ x: 7.702224055368173, y: 4.0454597514877815 },
		{ x: 7.0917788272359035, y: 5.210246929423622 },
		{ x: 6.304371863546932, y: 6.282109152674561 },
		{ x: 5.354285969788954, y: 7.234059838964624 },
		{ x: 4.2599311475821215, y: 8.041329903558204 },
		{ x: 3.043496877131155, y: 8.682000158885774 },
		{ x: 1.7305074045167497, y: 9.137578679437588 },
		{ x: 0.3492888170336816, y: 9.393508254230413 },
		{ x: -1.0696410300215171, y: 9.439590460761218 },
		{ x: -2.4942466196521282, y: 9.270314654873026 },
		{ x: -3.8916980264292373, y: 8.885082243349604 },
		{ x: -5.229126988573421, y: 8.288318945200691 },
		{ x: -6.474398397281438, y: 7.4894703012482235 },
		{ x: -7.596879128588252, y: 6.502878401571091 },
		{ x: -8.568185892647293, y: 5.34754060377661 },
		{ x: -9.362893960225804, y: 4.046753845932163 },
		{ x: -9.95918924872439, y: 2.6276509486787023 },
		{ x: -10.339447301911667, y: 1.1206379839141283 },
		{ x: -10.490724160137182, y: -0.4412557035479118 },
		{ x: -10.405145962227639, y: -2.0231009625664824 },
		{ x: -10.080186308176753, y: -3.588849954016671 },
		{ x: -9.518822895912072, y: -5.102157453103504 },
		{ x: -8.729567670892393, y: -6.527223627187126 },
		{ x: -7.726367632529772, y: -7.829638766060396 },
		{ x: -6.528376459743679, y: -8.977210078853233 },
		{ x: -5.159600179007174, y: -9.94075077611287 },
		{ x: -3.64842312969945, y: -10.694812231482773 },
		{ x: -2.027023410803429, y: -11.218341057930726 },
		{ x: -0.33068974878554397, y: -11.495244420630975 },
		{ x: 1.4029457591704253, y: -11.514848813459302 },
		{ x: 3.1347423627470117, y: -11.27223980933686 },
		{ x: 4.8249343249068914, y: -10.7684729075359 },
		{ x: 6.434043587475579, y: -10.01064848621026 },
		{ x: 7.923800498929045, y: -9.011846961260005 },
		{ x: 9.258051160210673, y: -7.790923482804922 },
		{ x: 10.403629935996701, y: -6.372164793445994 },
		{ x: 11.331176176357346, y: -4.784814151077453 },
		{ x: 12.015875192444225, y: -3.062473405533958 },
		{ x: 12.438105012954722, y: -1.2423943362354386 },
		{ x: 12.583972387268082, y: 0.635325866366008 },
		{ x: 12.445723856738153, y: 2.528627628144971 },
		{ x: 12.022020437719856, y: 4.394431088894822 },
		{ x: 11.318067489246003, y: 6.189616168137724 },
		{ x: 10.345594607581141, y: 7.872018306354934 },
		{ x: 9.12268382535478, y: 9.401416905052635 },
		{ x: 7.673447915950395, y: 10.740493335093865 },
		{ x: 6.027564132570743, y: 11.855735769143383 },
		{ x: 4.2196721630181555, y: 12.718269018881807 },
		{ x: 2.2886483736012058, y: 13.304589006129115 },
		{ x: 0.2767714693106877, y: 13.597183441940274 },
		{ x: -1.7712025622682004, y: 13.585022689838013 },
		{ x: -3.80903599724282, y: 13.263907598129123 },
		{ x: -5.790053269148045, y: 12.636664241026075 },
		{ x: -7.668209643139894, y: 11.713178939504656 },
		{ x: -9.399160211455195, y: 10.510270563567646 },
		{ x: -10.941304418351761, y: 9.051400865333235 },
		{ x: -12.256781564537944, y: 7.366227370859644 },
		{ x: -13.312393558763382, y: 5.490007079830973 },
		{ x: -14.080432565772156, y: 3.4628627984287617 },
		{ x: -14.539393119856364, y: 1.3289272765175715 },
		{ x: -14.674550693518377, y: -0.8646166453164496 },
		{ x: -14.478391580816234, y: -3.0685790249802127 },
		{ x: -13.95088221327135, y: -5.232865894653519 },
		{ x: -13.099569601402612, y: -7.307617686907785 },
		{ x: -11.939508407416627, y: -9.2443571431023 },
		{ x: -10.493014118263751, y: -10.997120291872616 },
		{ x: -8.789245812571346, y: -12.523544148770183 },
		{ x: -6.863626006842556, y: -13.785885464423144 },
		{ x: -4.757108932407603, y: -14.751946129416504 },
		{ x: -2.51531224345711, y: -15.39588270668212 },
		{ x: -0.18753050062708154, y: -15.698879969963887 },
		{ x: 2.1743482672818657, y: -15.649671230174999 },
		{ x: 4.516999122021397, y: -15.24489156837977 },
		{ x: 6.786864117392151, y: -14.489253792105842 },
		{ x: 8.931376364142524, y: -13.395540908900804 },
		{ x: 10.90017629075737, y: -11.984413078261682 },
		{ x: 12.646291983307188, y: -10.28403126565352 },
		{ x: 14.12725598767082, y: -8.329504082405972 },
		{ x: 15.306132102699715, y: -6.162168453937623 },
		{ x: 16.15242746386483, y: -3.8287187183944615 },
		{ x: 16.64286757947037, y: -1.3802024243613706 },
		{ x: 16.76201488737094, y: 1.1290956184282908 },
		{ x: 16.50271478789206, y: 3.642856657828808 },
		{ x: 15.866356905086537, y: 6.103992018377137 },
		{ x: 14.862943450053882, y: 8.455939451089955 },
		{ x: 13.510960914873792, y: 10.643962380464892 },
		{ x: 11.837055815446131, y: 12.616422219552264 },
		{ x: 9.875519723720613, y: 14.325994212842765 },
		{ x: 7.667593280150782, y: 15.730798240718295 },
		{ x: 5.260603152014368, y: 16.79541766307155 },
		{ x: 2.7069499017975183, y: 17.491781562469782 },
		{ x: 0.06296835680106729, y: 17.79988862285495 },
		{ x: -2.612314761220981, y: 17.708354287971154 },
		{ x: -5.258498557209351, y: 17.214766711280948 },
		{ x: -7.815171618789744, y: 16.325841251490314 },
		{ x: -10.223290821037176, y: 15.057367790835707 },
		{ x: -12.426543818833062, y: 13.433949855445398 },
		{ x: -14.37266380821428, y: 11.488539291661365 },
		{ x: -16.014665904702863, y: 9.261774989749396 },
		{ x: -17.31197596684416, y: 6.801138737256431 },
		{ x: -18.231424860117677, y: 4.159945621024746 },
		{ x: -18.74808396693413, y: 1.3961903769856576 },
		{ x: -18.845921144223194, y: -1.4287253849922117 },
		{ x: -18.518260238692424, y: -4.2513571635494465 },
		{ x: -17.768031606200935, y: -7.007642459561174 },
		{ x: -16.607805750147467, y: -9.634354579595293 },
		{ x: -15.05960709004254, y: -12.070552360747234 },
		{ x: -13.154509884984225, y: -14.258992590146491 },
		{ x: -10.932023353291799, y: -16.14747241530646 },
		{ x: -8.43927793362162, y: -17.6900703209198 },
		{ x: -5.730029310544734, y: -18.848256261529837 },
		{ x: -2.863501169001756, y: -19.59184424843986 },
		{ x: 0.09690845582042948, y: -19.899764037575697 },
		{ x: 3.0850289977520533, y: -19.760632481857193 },
		{ x: 6.033396359467922, y: -19.173109512271605 },
		{ x: 8.874776036023968, y: -18.146028499658414 },
		{ x: 11.543695975799777, y: -16.698295817786462 },
		{ x: 13.977954239385625, y: -14.858559663764257 },
		{ x: 16.120066760018574, y: -12.66465347542305 },
		{ x: 17.918621550255555, y: -10.162824496109243 },
		{ x: 19.32950752212159, y: -7.406763054954967 },
		{ x: 20.316988657311153, y: -4.456452838154016 },
		{ x: 20.8545975279861, y: -1.3768667131269745 },
		{ x: 20.925826058699613, y: 1.7634635695271574 },
		{ x: 20.524595852372162, y: 4.893972322846621 },
		{ x: 19.65549528123113, y: 7.9436455893690345 },
		{ x: 18.333775759279803, y: 10.842631894906589 },
		{ x: 16.585105049553015, y: 13.523841558347709 },
		{ x: 14.445080994410516, y: 15.924497953308345 },
		{ x: 11.958514564348137, y: 17.98760488264836 },
		{ x: 9.178496473741403, y: 19.66329581940724 },
		{ x: 6.165266686491595, y: 20.910033158377313 },
		{ x: 2.9849108119514653, y: 21.695628763525086 },
		{ x: -0.29208843890780006, y: 21.99806092235991 },
		{ x: -3.592413005337035, y: 21.806067247421925 },
		{ x: -6.84154983778912, y: 21.119498001066447 },
		{ x: -9.965473168409329, y: 19.94941965395775 },
		{ x: -12.892330711710496, y: 18.317964101392068 },
		{ x: -15.554095393817805, y: 16.25792472857523 },
		{ x: -17.88814466076967, y: 13.812106305534282 },
		{ x: -19.838730739934185, y: 11.032441372080468 },
		{ x: -21.35830740072107, y: 7.9788912122115105 },
		{ x: -22.40868173887315, y: 4.7181545890205445 },
		{ x: -22.961963231321157, y: 1.322211996412771 },
		{ x: -23.001286696922953, y: -2.133262826272901 },
		{ x: -22.521290757526153, y: -5.57058907252813 },
		{ x: -21.528338814980675, y: -8.91182517037892 },
		{ x: -20.0404753228032, y: -12.080535949870724 },
		{ x: -18.08711610716979, y: -15.00354061299406 },
		{ x: -15.708477545876368, y: -17.61260154522043 },
		{ x: -12.954755408074865, y: -19.84601502360003 },
		{ x: -9.885069954441772, y: -21.65006678963822 },
		{ x: -6.566199362855828, y: -22.98031822945964 },
		{ x: -3.071128551057185, y: -23.802692482634917 },
		{ x: 0.522555102974962, y: -24.09433410917094 },
		{ x: 4.134383895893756, y: -23.844220888957096 },
		{ x: 7.682811569795702, y: -23.05351180152423 },
		{ x: 11.087054375464692, y: -21.735621115475237 },
		{ x: 14.26892986366989, y: -19.916014675272596 },
		{ x: 17.15465155760944, y: -17.631730769751783 },
		{ x: 19.676538329242664, y: -14.930634259061078 },
		{ x: 21.774598916257236, y: -11.870418780992239 },
		{ x: 23.397954545300617, y: -8.517377712421254 },
		{ x: 24.506066020252916, y: -4.944969990910934 }
	];

	$: d = points.length === 0 ? '' : points.reduce((acc, { x, y }) => `${acc} ${x} ${y}`, 'M');

	const handleSwirl = () => {
		r += dr;
		a = (a + da) % TAU;

		const x = Math.cos(a) * r;
		const y = Math.sin(a) * r;

		points = [
			...points,
			{
				x,
				y
			}
		];

		if (r >= rMax) {
			cancelAnimationFrame(frame);
			state = 'end';
			return;
		}

		frame = requestAnimationFrame(handleSwirl);
	};

	const handleStart = () => {
		if (state !== 'start') return;

		frame = requestAnimationFrame(handleSwirl);
		state = 'draw';
	};

	const handleEnd = () => {
		cancelAnimationFrame(frame);

		if (r <= rMax) {
			state = 'start';
		}
	};

	const handleClear = () => {
		points = [];
		r = 0;
		a = 0;

		state = 'start';
	};

	onMount(() => {
		state = 'start';
		points = [];

		return () => {
			cancelAnimationFrame(frame);
		};
	});
</script>

<div class="layout">
	{#if state !== null}
		<div class="controls">
			<button
				disabled={r >= rMax}
				on:pointerdown={handleStart}
				on:pointerup={handleEnd}
				on:pointerout={handleEnd}
				aria-label="Keep pressing the button to draw the spiral"
				on:keydown={(e) => {
					const { code } = e;
					if (code === 'Space') {
						e.preventDefault();
						handleStart();
					}
				}}
				on:keyup={handleEnd}
				on:blur={handleEnd}
			>
				Draw
			</button>

			<button disabled={r === 0} on:click={handleClear}> Clear </button>
		</div>
	{/if}

	<svg style="display: block;" viewBox="-27 -27 54 54">
		<path fill="none" stroke="currentColor" stroke-linecap="round" {d} />
	</svg>
</div>

<style>
	.layout {
		position: relative;
	}

	.controls {
		position: absolute;
		inline-size: 100%;
		inset-block-start: 0;
		inset-inline-start: 50%;
		translate: -50% 0%;
		display: flex;
		flex-wrap: wrap;
		justify-content: center;
		align-items: center;
		gap: 1rem;
	}

	button {
		color: hsl(0 0% 20%);
		background: hsl(0 0% 99%);
		text-transform: uppercase;
		letter-spacing: 0.1rem;
		font-weight: 700;
		padding: 0.5rem 1rem;
		border-radius: 0.5rem;
		border: none;
		box-shadow: 0 0.1rem currentColor;
		transition: translate 0.2s ease-out, box-shadow 0.2s ease-out;
	}

	button:disabled {
		opacity: 0.5;
	}

	button:not(:disabled):active {
		translate: 0 0.1rem;
		box-shadow: 0 0px currentColor;
	}

	svg {
		display: block;
	}
</style>
